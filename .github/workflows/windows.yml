name: Windows VPS via Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: windows-latest
    steps:

      # 1. Ù†Ø²Ù‘Ù„ cloudflared (Ø£Ø¯Ø§Ø© Cloudflare Tunnel)
      - name: Download Cloudflared
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile cloudflared.exe

      # 2. ÙØ¹Ù‘Ù„ RDP ÙˆÙØªØ­ Ø§Ù„ÙØ§ÙŠÙŠØ±ÙˆØ§Ù„ØŒ ÙˆØµÙ†Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ runneradmin
      - name: Enable RDP & Create User
        shell: powershell
        run: |
          # ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø¹Ø¨Ø± RDP
          Set-ItemProperty -Path HKLM:\System\CurrentControlSet\Control\Terminal Server -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… runneradmin Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø«Ø§Ø¨ØªØ©
          net user runneradmin P@ssw0rd! /add
          net localgroup "Remote Desktop Users" runneradmin /add
          net localgroup Administrators runneradmin /add

      # 3. Ø´ØºÙ‘Ù„ Tunnel Ø¹Ù„Ù‰ Ø¨ÙˆØ±Øª RDP (3389)
      - name: Start Cloudflare Tunnel
        shell: powershell
        run: |
          # Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ§Ù†Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          Start-Process -FilePath .\cloudflared.exe -ArgumentList "tunnel --url tcp://localhost:3389 --no-autoupdate" -WindowStyle Hidden
          Start-Sleep -Seconds 10

      # 4. Ø§Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
      - name: Show Connection Info
        shell: powershell
        run: |
          # Ø§Ø³Ø­Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ù†Ù„ (public URL)
          $info = .\cloudflared.exe tunnel info --url tcp://localhost:3389 | Select-String '"url":'
          $url = ($info -split '"')[3]
          Write-Host "ğŸ“Œ Connect via Remote Desktop:"
          Write-Host "Address: $($url -replace 'tcp://','')"
          Write-Host "User: runneradmin"
          Write-Host "Pass: P@ssw0rd!"
